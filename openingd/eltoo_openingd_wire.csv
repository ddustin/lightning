#include <bitcoin/chainparams.h>
#include <bitcoin/signature.h>
#include <common/cryptomsg.h>
#include <common/channel_config.h>
#include <common/channel_id.h>
#include <common/channel_type.h>
#include <common/derive_basepoints.h>
#include <common/features.h>

# Eltoo variant
msgtype,openingd_eltoo_init,6500
# Which network are we configured for?
msgdata,openingd_eltoo_init,chainparams,chainparams,
msgdata,openingd_eltoo_init,our_features,feature_set,
msgdata,openingd_eltoo_init,their_init_features_len,u16,
msgdata,openingd_eltoo_init,their_init_features,u8,their_init_features_len
msgdata,openingd_eltoo_init,our_config,channel_config,
# Minimum/maximum configuration values we'll accept
msgdata,openingd_eltoo_init,max_shared_delay,u32,
msgdata,openingd_eltoo_init,min_effective_htlc_capacity_msat,amount_msat,
msgdata,openingd_eltoo_init,our_funding_pubkey,pubkey,
msgdata,openingd_eltoo_init,our_settle_pubkey,pubkey,
# Constraints in case the other end tries to open a channel.
msgdata,openingd_eltoo_init,minimum_depth,u32,
msgdata,openingd_eltoo_init,min_feerate,u32,
msgdata,openingd_eltoo_init,max_feerate,u32,
msgdata,openingd_eltoo_init,dev_temporary_channel_id,?byte,32

#include <common/penalty_base.h>
# Openingd->master: we've successfully offered channel.
# This gives their psig, means we can broadcast tx: we're done.
msgtype,openingd_eltoo_funder_reply,6601
msgdata,openingd_eltoo_funder_reply,their_config,channel_config,
msgdata,openingd_eltoo_funder_reply,first_commit,bitcoin_tx,
msgdata,openingd_eltoo_funder_reply,first_update_sig,bip340sig,
msgdata,openingd_eltoo_funder_reply,minimum_depth,u32,
msgdata,openingd_eltoo_funder_reply,remote_funding_key,pubkey,
msgdata,openingd_eltoo_funder_reply,remote_settlement_key,pubkey,
msgdata,openingd_eltoo_funder_reply,funding,bitcoin_outpoint,
msgdata,openingd_eltoo_funder_reply,shutdown_len,u16,
msgdata,openingd_eltoo_funder_reply,shutdown_scriptpubkey,u8,shutdown_len
msgdata,openingd_eltoo_funder_reply,channel_type,channel_type,

# master->openingd: start channel establishment for a funding tx
msgtype,openingd_eltoo_funder_start,6502
msgdata,openingd_eltoo_funder_start,funding_satoshis,amount_sat,
msgdata,openingd_eltoo_funder_start,push_msat,amount_msat,
msgdata,openingd_eltoo_funder_start,len_upfront,u16,
msgdata,openingd_eltoo_funder_start,upfront_shutdown_script,u8,len_upfront
msgdata,openingd_eltoo_funder_start,upfront_shutdown_wallet_index,?u32,
msgdata,openingd_eltoo_funder_start,temporary_channel_id,channel_id,
msgdata,openingd_eltoo_funder_start,channel_flags,u8,

# openingd->master: send back output script for 2-of-2 funding output
msgtype,openingd_eltoo_funder_start_reply,6602
msgdata,openingd_eltoo_funder_start_reply,script_len,u8,
msgdata,openingd_eltoo_funder_start_reply,scriptpubkey,u8,script_len
msgdata,openingd_eltoo_funder_start_reply,upfront_shutdown_negotiated,bool,
msgdata,openingd_eltoo_funder_start_reply,channel_type,channel_type,

# master->openingd: complete channel establishment for a funding
# tx that will be paid for by an external wallet
# response to this is a normal `openingd_eltoo_funder_reply` ??
msgtype,openingd_eltoo_funder_complete,6512
msgdata,openingd_eltoo_funder_complete,funding_txid,bitcoin_txid,
msgdata,openingd_eltoo_funder_complete,funding_txout,u16,
msgdata,openingd_eltoo_funder_complete,channel_type,channel_type,

#master->openingd: cancel channel establishment for a funding
msgtype,openingd_eltoo_funder_cancel,6513

# Openingd->master: we failed to negotiation channel
msgtype,openingd_eltoo_failed,6504
msgdata,openingd_eltoo_failed,reason,wirestring,

# Openingd->master: they offered channel.
# This gives their txid and info, means we can send funding_signed: we're done.
msgtype,openingd_eltoo_fundee,6503
msgdata,openingd_eltoo_fundee,their_config,channel_config,
msgdata,openingd_eltoo_fundee,first_settlement,bitcoin_tx,
msgdata,openingd_eltoo_fundee,first_update_sig,bip340sig,
msgdata,openingd_eltoo_fundee,remote_fundingkey,pubkey,
msgdata,openingd_eltoo_fundee,remote_settlekey,pubkey,
msgdata,openingd_eltoo_fundee,funding,bitcoin_outpoint,
msgdata,openingd_eltoo_fundee,funding_satoshis,amount_sat,
msgdata,openingd_eltoo_fundee,push_msat,amount_msat,
msgdata,openingd_eltoo_fundee,channel_flags,u8,
# The funding signed message: send this and we're committed.
msgdata,openingd_eltoo_fundee,msglen,u16,
msgdata,openingd_eltoo_fundee,funding_signed_eltoo_msg,u8,msglen
msgdata,openingd_eltoo_fundee,local_shutdown_len,u16,
msgdata,openingd_eltoo_fundee,local_shutdown_scriptpubkey,u8,local_shutdown_len
msgdata,openingd_eltoo_fundee,remote_shutdown_len,u16,
msgdata,openingd_eltoo_fundee,remote_shutdown_scriptpubkey,u8,remote_shutdown_len
msgdata,openingd_eltoo_fundee,channel_type,channel_type,

# master -> openingd: do you have a memleak?
msgtype,openingd_eltoo_dev_memleak,6533

msgtype,openingd_eltoo_dev_memleak_reply,6133
msgdata,openingd_eltoo_dev_memleak_reply,leak,bool,

# Openingd->master: they offered channel, should we continue?
msgtype,openingd_eltoo_got_offer,6505
msgdata,openingd_eltoo_got_offer,funding_satoshis,amount_sat,
msgdata,openingd_eltoo_got_offer,push_msat,amount_msat,
msgdata,openingd_eltoo_got_offer,dust_limit_satoshis,amount_sat,
msgdata,openingd_eltoo_got_offer,max_htlc_value_in_flight_msat,amount_msat,
msgdata,openingd_eltoo_got_offer,htlc_minimum_msat,amount_msat,
msgdata,openingd_eltoo_got_offer,shared_delay,u16,
msgdata,openingd_eltoo_got_offer,max_accepted_htlcs,u16,
msgdata,openingd_eltoo_got_offer,channel_flags,u8,
msgdata,openingd_eltoo_got_offer,shutdown_len,u16,
msgdata,openingd_eltoo_got_offer,shutdown_scriptpubkey,u8,shutdown_len

# master->openingd: optional rejection message
msgtype,openingd_eltoo_got_offer_reply,6605
msgdata,openingd_eltoo_got_offer_reply,rejection,?wirestring,
msgdata,openingd_eltoo_got_offer_reply,shutdown_len,u16,
msgdata,openingd_eltoo_got_offer_reply,our_shutdown_scriptpubkey,?u8,shutdown_len
msgdata,openingd_eltoo_got_offer_reply,our_shutdown_wallet_index,?u32,

